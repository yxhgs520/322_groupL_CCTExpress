{% extends 'base.html' %}

{% block title %}Forum - Restaurant{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-comments"></i> Forum</h2>
                <div>
                    {% if is_manager %}
                    <button type="button" class="btn btn-warning me-2" data-bs-toggle="modal" data-bs-target="#createAnnouncementModal">
                        <i class="fas fa-bullhorn"></i> New Announcement
                    </button>
                    {% endif %}
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createPostModal">
                        <i class="fas fa-plus"></i> New Post
                    </button>
                </div>
            </div>

            <!-- Announcements Section (Pinned) -->
            {% if announcements %}
            <div class="mb-4">
                <h3><i class="fas fa-bullhorn text-warning"></i> Announcements</h3>
                {% for announcement in announcements %}
                <div class="card mb-3 border-warning">
                    <div class="card-header bg-warning text-dark">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h4 class="mb-0 fw-bold text-uppercase">
                                    <i class="fas fa-bullhorn"></i> {{ announcement.title }}
                                </h4>
                                <small class="text-muted">
                                    By <strong>{{ announcement.author.username }}</strong> (Manager)
                                    - {{ announcement.created_at|date:"F d, Y H:i" }}
                                </small>
                            </div>
                            {% if is_manager %}
                            <div>
                                <button class="btn btn-sm btn-outline-secondary" onclick="editAnnouncement({{ announcement.id }})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteAnnouncement({{ announcement.id }})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body bg-light">
                        <p class="card-text lead text-dark" style="font-size: 1.1em;">{{ announcement.content|linebreaks }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Posts List -->
            {% if posts %}
            {% for post in posts %}
            <div class="card mb-4" id="post-{{ post.id }}">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0">{{ post.title }}</h5>
                            <small class="text-muted">
                                By <strong>{{ post.author.username }}</strong> 
                                {% if post.author.customer %}
                                    {% if post.author.customer.is_vip %}
                                        <span class="badge bg-warning">VIP</span>
                                    {% endif %}
                                {% elif post.author.manager %}
                                    <span class="badge bg-info">Manager</span>
                                {% endif %}
                                - {{ post.created_at|date:"F d, Y H:i" }}
                            </small>
                        </div>
                        {% if post.author == user %}
                        <button class="btn btn-sm btn-outline-danger" onclick="deletePost({{ post.id }})" title="Delete Post">
                            <i class="fas fa-trash"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <p class="card-text">{{ post.content|linebreaks }}</p>
                    
                    <!-- Reactions -->
                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-sm btn-outline-success" onclick="togglePostReaction({{ post.id }}, 'approve')" id="approve-btn-{{ post.id }}">
                            üëç <span id="approve-count-{{ post.id }}">{{ post.get_approve_count }}</span>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="togglePostReaction({{ post.id }}, 'disapprove')" id="disapprove-btn-{{ post.id }}">
                            üëé <span id="disapprove-count-{{ post.id }}">{{ post.get_disapprove_count }}</span>
                        </button>
                    </div>

                    <!-- Comments Section -->
                    {% if post.allow_comments %}
                    <div class="mt-3">
                        <h6>Comments:</h6>
                        <div id="comments-{{ post.id }}">
                            {% for comment in post.comments.all %}
                            <div class="card mb-2" id="comment-{{ comment.id }}">
                                <div class="card-body p-2">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <strong>{{ comment.author.username }}</strong>
                                            <small class="text-muted"> - {{ comment.created_at|date:"M d, Y H:i" }}</small>
                                            <p class="mb-1 mt-1">{{ comment.content }}</p>
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-xs btn-outline-success btn-sm" onclick="toggleCommentReaction({{ comment.id }}, 'approve')" id="comment-approve-btn-{{ comment.id }}">
                                                    üëç <span id="comment-approve-count-{{ comment.id }}">{{ comment.get_approve_count }}</span>
                                                </button>
                                                <button class="btn btn-xs btn-outline-danger btn-sm" onclick="toggleCommentReaction({{ comment.id }}, 'disapprove')" id="comment-disapprove-btn-{{ comment.id }}">
                                                    üëé <span id="comment-disapprove-count-{{ comment.id }}">{{ comment.get_disapprove_count }}</span>
                                                </button>
                                                <button class="btn btn-xs btn-outline-warning btn-sm" onclick="fileComplaint({{ post.id }}, {{ comment.id }}, {{ comment.author.id }})">
                                                    <i class="fas fa-exclamation-triangle"></i> Complaint
                                                </button>
                                            </div>
                                        </div>
                                        {% if comment.author == user %}
                                        <button class="btn btn-xs btn-outline-danger btn-sm" onclick="deleteComment({{ comment.id }})" title="Delete Comment">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <p class="text-muted">No comments yet.</p>
                            {% endfor %}
                        </div>
                        
                        <!-- Add Comment Form -->
                        <div class="mt-3">
                            <div class="input-group">
                                <input type="text" class="form-control" id="comment-input-{{ post.id }}" placeholder="Write a comment...">
                                <button class="btn btn-primary" onclick="addComment({{ post.id }})">
                                    <i class="fas fa-paper-plane"></i> Comment
                                </button>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-lock"></i> Comments are disabled for this post.
                    </div>
                    {% endif %}

                    <!-- File Complaint Button -->
                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-warning" onclick="fileComplaint({{ post.id }}, null, {{ post.author.id }})">
                            <i class="fas fa-exclamation-triangle"></i> File a Complaint
                        </button>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-5">
                <i class="fas fa-comments fa-4x text-muted mb-3"></i>
                <h4 class="text-muted">No posts yet</h4>
                <p class="text-muted">Be the first to start a discussion!</p>
            </div>
            {% endfor %}

            <!-- Pagination -->
            {% if posts.has_other_pages %}
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    {% if posts.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ posts.previous_page_number }}">Previous</a>
                    </li>
                    {% endif %}
                    <li class="page-item active">
                        <span class="page-link">Page {{ posts.number }} of {{ posts.paginator.num_pages }}</span>
                    </li>
                    {% if posts.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ posts.next_page_number }}">Next</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-comments fa-4x text-muted mb-3"></i>
                <h4 class="text-muted">No posts yet</h4>
                <p class="text-muted">Be the first to start a discussion!</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Create Announcement Modal -->
{% if is_manager %}
<div class="modal fade" id="createAnnouncementModal" tabindex="-1" aria-labelledby="createAnnouncementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title" id="createAnnouncementModalLabel">
                    <i class="fas fa-bullhorn"></i> Create New Announcement
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createAnnouncementForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="announcementTitle" class="form-label">Title *</label>
                        <input type="text" class="form-control" id="announcementTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="announcementContent" class="form-label">Content *</label>
                        <textarea class="form-control" id="announcementContent" name="content" rows="5" required></textarea>
                        <small class="text-muted">This announcement will be added to the knowledge base for AI customer service.</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="submitAnnouncement()">Create Announcement</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Announcement Modal -->
<div class="modal fade" id="editAnnouncementModal" tabindex="-1" aria-labelledby="editAnnouncementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title" id="editAnnouncementModalLabel">
                    <i class="fas fa-edit"></i> Edit Announcement
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editAnnouncementForm">
                    {% csrf_token %}
                    <input type="hidden" id="editAnnouncementId" name="announcement_id">
                    <div class="mb-3">
                        <label for="editAnnouncementTitle" class="form-label">Title *</label>
                        <input type="text" class="form-control" id="editAnnouncementTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="editAnnouncementContent" class="form-label">Content *</label>
                        <textarea class="form-control" id="editAnnouncementContent" name="content" rows="5" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="submitEditAnnouncement()">Update Announcement</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Create Post Modal -->
<div class="modal fade" id="createPostModal" tabindex="-1" aria-labelledby="createPostModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createPostModalLabel">
                    <i class="fas fa-plus"></i> Create New Post
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createPostForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="postTitle" class="form-label">Title *</label>
                        <input type="text" class="form-control" id="postTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="postContent" class="form-label">Content *</label>
                        <textarea class="form-control" id="postContent" name="content" rows="5" required></textarea>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="allowComments" name="allow_comments" checked>
                        <label class="form-check-label" for="allowComments">
                            Allow comments
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitPost()">Create Post</button>
            </div>
        </div>
    </div>
</div>

<!-- File Complaint Modal -->
<div class="modal fade" id="fileComplaintModal" tabindex="-1" aria-labelledby="fileComplaintModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fileComplaintModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> File a Complaint
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="fileComplaintForm">
                    {% csrf_token %}
                    <input type="hidden" id="complaintPostId" name="post_id">
                    <input type="hidden" id="complaintCommentId" name="comment_id">
                    <input type="hidden" id="complaintReportedUserId" name="reported_user_id">
                    <div class="mb-3">
                        <label for="complaintTitle" class="form-label">Title *</label>
                        <input type="text" class="form-control" id="complaintTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="complaintDescription" class="form-label">Description *</label>
                        <textarea class="form-control" id="complaintDescription" name="description" rows="4" required></textarea>
                    </div>
                    <div class="alert alert-info">
                        <small>Your complaint will be reviewed by management. If found valid, a warning will be added to the reported user.</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="submitComplaint()">Submit Complaint</button>
            </div>
        </div>
    </div>
</div>

<script>
function getCsrfToken() {
    const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfInput) {
        return csrfInput.value;
    }
    const name = 'csrftoken=';
    const decodedCookies = decodeURIComponent(document.cookie || '');
    const cookies = decodedCookies.split(';');
    for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name)) {
            return cookie.substring(name.length);
        }
    }
    return '';
}

function submitPost() {
    const title = document.getElementById('postTitle').value.trim();
    const content = document.getElementById('postContent').value.trim();
    const allowComments = document.getElementById('allowComments').checked;
    
    if (!title || !content) {
        alert('Please fill in all required fields.');
        return;
    }
    
    fetch('{% url "create_forum_post" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            title: title,
            content: content,
            allow_comments: allowComments
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Post created successfully!');
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to create post'));
        }
    })
    .catch(error => {
        alert('Error: Failed to create post');
        console.error('Error:', error);
    });
}

function submitAnnouncement() {
    const title = document.getElementById('announcementTitle').value.trim();
    const content = document.getElementById('announcementContent').value.trim();
    
    if (!title || !content) {
        alert('Please fill in all required fields.');
        return;
    }
    
    fetch('{% url "create_announcement" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            title: title,
            content: content
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Announcement created successfully!');
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to create announcement'));
        }
    })
    .catch(error => {
        alert('Error: Failed to create announcement');
        console.error('Error:', error);
    });
}

function editAnnouncement(announcementId) {
    fetch('/forum/announcement/' + announcementId + '/', {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('editAnnouncementId').value = announcementId;
            document.getElementById('editAnnouncementTitle').value = data.announcement.title;
            document.getElementById('editAnnouncementContent').value = data.announcement.content;
            const modal = new bootstrap.Modal(document.getElementById('editAnnouncementModal'));
            modal.show();
        } else {
            alert('Error: ' + (data.error || 'Failed to load announcement'));
        }
    })
    .catch(error => {
        alert('Error: Failed to load announcement');
        console.error('Error:', error);
    });
}

function submitEditAnnouncement() {
    const announcementId = document.getElementById('editAnnouncementId').value;
    const title = document.getElementById('editAnnouncementTitle').value.trim();
    const content = document.getElementById('editAnnouncementContent').value.trim();
    
    if (!title || !content) {
        alert('Please fill in all required fields.');
        return;
    }
    
    fetch('/forum/announcement/' + announcementId + '/update/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            title: title,
            content: content
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Announcement updated successfully!');
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to update announcement'));
        }
    })
    .catch(error => {
        alert('Error: Failed to update announcement');
        console.error('Error:', error);
    });
}

function deleteAnnouncement(announcementId) {
    if (!confirm('Are you sure you want to delete this announcement?')) {
        return;
    }
    
    fetch('/forum/announcement/' + announcementId + '/delete/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Announcement deleted successfully!');
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to delete announcement'));
        }
    })
    .catch(error => {
        alert('Error: Failed to delete announcement');
        console.error('Error:', error);
    });
}

function deletePost(postId) {
    if (!confirm('Are you sure you want to delete this post?')) {
        return;
    }
    
    fetch(`/forum/post/${postId}/delete/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Post deleted successfully!');
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to delete post'));
        }
    })
    .catch(error => {
        alert('Error: Failed to delete post');
        console.error('Error:', error);
    });
}

function addComment(postId) {
    const input = document.getElementById(`comment-input-${postId}`);
    const content = input.value.trim();
    
    if (!content) {
        alert('Please enter a comment.');
        return;
    }
    
    fetch(`/forum/post/${postId}/comment/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            content: content
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            input.value = '';
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to add comment'));
        }
    })
    .catch(error => {
        alert('Error: Failed to add comment');
        console.error('Error:', error);
    });
}

function deleteComment(commentId) {
    if (!confirm('Are you sure you want to delete this comment?')) {
        return;
    }
    
    fetch(`/forum/comment/${commentId}/delete/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Comment deleted successfully!');
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to delete comment'));
        }
    })
    .catch(error => {
        alert('Error: Failed to delete comment');
        console.error('Error:', error);
    });
}

function togglePostReaction(postId, reactionType) {
    fetch(`/forum/post/${postId}/reaction/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            reaction_type: reactionType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById(`approve-count-${postId}`).textContent = data.approve_count;
            document.getElementById(`disapprove-count-${postId}`).textContent = data.disapprove_count;
        } else {
            alert('Error: ' + (data.error || 'Failed to toggle reaction'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function toggleCommentReaction(commentId, reactionType) {
    fetch(`/forum/comment/${commentId}/reaction/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            reaction_type: reactionType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById(`comment-approve-count-${commentId}`).textContent = data.approve_count;
            document.getElementById(`comment-disapprove-count-${commentId}`).textContent = data.disapprove_count;
        } else {
            alert('Error: ' + (data.error || 'Failed to toggle reaction'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function fileComplaint(postId, commentId, reportedUserId) {
    document.getElementById('complaintPostId').value = postId || '';
    document.getElementById('complaintCommentId').value = commentId || '';
    document.getElementById('complaintReportedUserId').value = reportedUserId;
    
    const modal = new bootstrap.Modal(document.getElementById('fileComplaintModal'));
    modal.show();
}

function submitComplaint() {
    const title = document.getElementById('complaintTitle').value.trim();
    const description = document.getElementById('complaintDescription').value.trim();
    const postId = document.getElementById('complaintPostId').value;
    const commentId = document.getElementById('complaintCommentId').value;
    const reportedUserId = document.getElementById('complaintReportedUserId').value;
    
    if (!title || !description) {
        alert('Please fill in all required fields.');
        return;
    }
    
    const data = {
        title: title,
        description: description,
        reported_user_id: parseInt(reportedUserId)
    };
    
    if (postId) {
        data.post_id = parseInt(postId);
    }
    if (commentId) {
        data.comment_id = parseInt(commentId);
    }
    
    fetch('{% url "file_forum_complaint" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Complaint filed successfully! It will be reviewed by management.');
            bootstrap.Modal.getInstance(document.getElementById('fileComplaintModal')).hide();
            document.getElementById('fileComplaintForm').reset();
        } else {
            alert('Error: ' + (data.error || 'Failed to file complaint'));
        }
    })
    .catch(error => {
        alert('Error: Failed to file complaint');
        console.error('Error:', error);
    });
}
</script>
{% endblock %}

